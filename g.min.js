/*
 Copyright 2011  Metamedia Technologies
 ------------
*/
(function(h){var a={version:"0.1",global:h,doc:h.document,game:null,modules:{},resources:[],ready:!1,baked:!1,nocache:"",ua:{},_current:null,_loadQueue:[],_waitForOnload:0,$:function(b){return b.charAt(0)=="#"?a.doc.getElementById(b.substr(1)):a.doc.getElementsByTagName(b)[0]},$new:function(b){return a.doc.createElement(b)},copy:function(b){if(!b||typeof b!="object"||b instanceof a.Class)return b;else{if(b instanceof Array)for(var c=[],e=0,d=b.length;e<d;e++)c[e]=a.copy(b[e]);else for(e in c={},b)c[e]=
a.copy(b[e]);return c}},module:function(b){if(a._current)throw"Module '"+a._current.name+"' defines nothing";a._current={name:b,requires:[],loaded:!1,body:null};a.modules[b]=a._current;a._loadQueue.push(a._current);a._initDOMReady();return a},requires:function(){a._current.requires=Array.prototype.slice.call(arguments);return a},defines:function(b){name=a._current.name;a._current.body=b;a._current=null;a._execModules()},addResource:function(b){a.resources.push(b)},setNocache:function(b){a.nocache=
b?"?"+Math.random().toString().substr(2):""},_loadScript:function(b,c){a.modules[b]={name:b,requires:[],loaded:!1,body:null};a._waitForOnload++;var e="lib/"+b+".js"+a.nocache,d=a.$new("script");d.type="text/javascript";d.src=e;d.onload=function(){a._waitForOnload--;a._execModules()};d.onerror=function(){throw"Failed to load module "+b+" at "+e+" required from "+c;};a.$("head").appendChild(d)},_execModules:function(){for(var b=!1,c=0;c<a._loadQueue.length;c++){for(var e=a._loadQueue[c],d=!0,f=0;f<
e.requires.length;f++){var i=e.requires[f];a.modules[i]?a.modules[i].loaded||(d=!1):(d=!1,a._loadScript(i,e.name))}if(d&&e.body)a._loadQueue.splice(c,1),e.loaded=!0,e.body(),b=!0,c--}if(b)a._execModules();else if(!a.baked&&a._waitForOnload==0&&a._loadQueue.length!=0){b=[];for(c=0;c<a._loadQueue.length;c++)b.push(a._loadQueue[c].name);throw"Unresolved (circular?) dependencies: "+b.join(", ");}},_DOMReady:function(){if(!a.modules["dom.ready"].loaded){if(!a.doc.body)return setTimeout(a._DOMReady,13);
a.modules["dom.ready"].loaded=!0;a._waitForOnload--;a._execModules()}return 0},_isCanvas:function(){var b=a.doc.createElement("canvas");return!(!b.getContext||!b.getContext("2d"))},_boot:function(){a.doc.location.href.match(/\?nocache/)&&a.setNocache(!0);a.ua.iPhone=/iPhone/i.test(navigator.userAgent);a.ua.iPhone4=a.ua.iPhone&&h.devicePixelRatio==2;a.ua.iPad=/iPad/i.test(navigator.userAgent);a.ua.android=/android/i.test(navigator.userAgent);a.ua.iOS=a.ua.iPhone||a.ua.iPad;a.ua.mobile=a.ua.iOS||a.ua.android;
a.ua.desktop=!a.ua.mobile;a.ua.webkit=/(webkit)[ \/]([\w.]+)/i.test(navigator.userAgent);a.ua.opera=/(opera)(?:.*version)?[ \/]([\w.]+)/i.test(navigator.userAgent);a.ua.msie=/(msie) ([\w.]+)/i.test(navigator.userAgent);a.ua.mozilla=/(mozilla)(?:.*? rv:([\w.]+))?/i.test(navigator.userAgent);a.ua.chrome=/(chrome)[ \/]([\w.]+)/i.test(navigator.userAgent)},_initDOMReady:function(){a.modules["dom.ready"]||(a._boot(),a.modules["dom.ready"]={requires:[],loaded:!1,body:null},a._waitForOnload++,a.doc.readyState===
"complete"?a._DOMReady():(a.doc.addEventListener("DOMContentLoaded",a._DOMReady,!1),h.addEventListener("load",a._DOMReady,!1)))},log:function(a){typeof console!=="undefined"&&console.log(a)}},n=!1,q=/xyz/.test(function(){xyz()})?/\bparent\b/:/.*/;a.Class=function(){};a.Class.extend=function(b){function c(){if(!n){if(this.staticInstantiate){var b=this.staticInstantiate.apply(this,arguments);if(b)return b}for(p in this)this[p]=a.copy(this[p]);this.init&&this.init.apply(this,arguments)}return this}var e=
this.prototype;n=!0;var d=new this;n=!1;for(var f in b)d[f]=typeof b[f]=="function"&&typeof e[f]=="function"&&q.test(b[f])?function(a,b){return function(){var c=this.parent;this.parent=e[a];var d=b.apply(this,arguments);this.parent=c;return d}}(f,b[f]):b[f];c.prototype=d;c.constructor=c;c.extend=arguments.callee;return c};a.module("g.loader").requires().defines(function(){a.Loader=a.Class.extend({resources:[],gameClass:null,status:0,done:!1,_unloaded:[],_drawStatus:0,_intervalId:0,_loadCallbackBound:null,
init:function(a,c){this.gameClass=a;this.resources=c;this._loadCallbackBound=this._loadCallback.bind(this);for(var e=0;e<this.resources.length;e++)this._unloaded.push(this.resources[e].path)},load:function(){a.system.clear("#000");if(this.resources.length){for(var b=0;b<this.resources.length;b++)this.loadResource(this.resources[b]);this._intervalId=setInterval(this.draw.bind(this),16)}else this.end()},loadResource:function(a){a.load(this._loadCallbackBound)},end:function(){if(!this.done)this.done=
!0,clearInterval(this._intervalId),a.system.setGame(this.gameClass)},draw:function(){this._drawStatus+=(this.status-this._drawStatus)/5;var b=a.system.scale,c=a.system.width*0.6,e=a.system.height*0.1,d=a.system.width*0.5-c/2,f=a.system.height*0.5-e/2;a.system.context.fillStyle="#000";a.system.context.fillRect(0,0,480,320);a.system.context.fillStyle="#fff";a.system.context.fillRect(d*b,f*b,c*b,e*b);a.system.context.fillStyle="#000";a.system.context.fillRect(d*b+b,f*b+b,c*b-b-b,e*b-b-b);a.system.context.fillStyle=
"#fff";a.system.context.fillRect(d*b,f*b,c*b*this._drawStatus,e*b)},_loadCallback:function(a,c){if(c)this.status=1-this._unloaded.length/this.resources.length,this.draw(),this._unloaded.erase(a);else throw"Failed to load resource: "+a;this.status=1-this._unloaded.length/this.resources.length;this._unloaded.length==0&&setTimeout(this.end.bind(this),250)}})});a.module("g.timer").defines(function(){a.Timer=a.Class.extend({target:0,base:0,last:0,init:function(b){this.last=this.base=a.Timer.time;this.target=
b||0},set:function(b){this.target=b||0;this.base=a.Timer.time},reset:function(){this.base=a.Timer.time},tick:function(){var b=a.Timer.time-this.last;this.last=a.Timer.time;return b},delta:function(){return a.Timer.time-this.base-this.target}});a.Timer._last=0;a.Timer.time=0;a.Timer.timeScale=1;a.Timer.maxStep=0.05;a.Timer.step=function(){var b=Date.now();a.Timer.time+=Math.min((b-a.Timer._last)/1E3,a.Timer.maxStep)*a.Timer.timeScale;a.Timer._last=b}});a.module("g.image").defines(function(){a.Image=
a.Class.extend({data:null,width:0,height:0,loaded:!1,failed:!1,loadCallback:null,path:"",staticInstantiate:function(b){return a.Image.cache[b]||null},init:function(a){this.path=a;this.load()},load:function(b){this.loaded?b&&b(this.path,!0):(!this.loaded&&a.ready?(this.loadCallback=b||null,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.onerror=this.onerror.bind(this),this.data.src=this.path+a.nocache):a.addResource(this),a.Image.cache[this.path]=this)},reload:function(){this.loaded=
!1;this.data=new Image;this.data.onload=this.onload.bind(this);this.data.src=this.path+"?"+Math.random()},onload:function(){this.width=this.data.width;this.height=this.data.height;a.system.scale!=1&&this.resize(a.system.scale);this.loaded=!0;this.loadCallback&&this.loadCallback(this.path,!0)},onerror:function(){this.failed=!0;this.loadCallback&&this.loadCallback(this.path,!1)},resize:function(b){var c=this.width*b,e=this.height*b,d=a.$new("canvas");d.width=this.width;d.height=this.height;d=d.getContext("2d");
d.drawImage(this.data,0,0,this.width,this.height,0,0,this.width,this.height);var d=d.getImageData(0,0,this.width,this.height),f=a.$new("canvas");f.width=c;f.height=e;for(var i=f.getContext("2d"),r=i.getImageData(0,0,c,e),h=0;h<e;h++)for(var k=0;k<c;k++){var j=((h/b).floor()*this.width+(k/b).floor())*4,l=(h*c+k)*4;r.data[l]=d.data[j];r.data[l+1]=d.data[j+1];r.data[l+2]=d.data[j+2];r.data[l+3]=d.data[j+3]}i.putImageData(r,0,0);this.data=f},draw:function(b,c,e,d,f,i){if(this.loaded){var h=a.system.scale,
f=(f?f:this.width)*h,i=(i?i:this.height)*h;a.system.context.drawImage(this.data,e?e*h:0,d?d*h:0,f,i,a.system.getDrawPos(b),a.system.getDrawPos(c),f,i)}},drawTile:function(b,c,e,d,f,i,h){f=f?f:d;if(this.loaded&&!(d>this.width||f>this.height)){var o=a.system.scale,k=d*o,j=f*o,l=i?-1:1,m=h?-1:1;if(i||h)a.system.context.save(),a.system.context.scale(l,m);a.system.context.drawImage(this.data,(e*d).floor()%this.width*o,(e*d/this.width).floor()*f*o,k,j,a.system.getDrawPos(b)*l-(i?k:0),a.system.getDrawPos(c)*
m-(h?j:0),k,j);(i||h)&&a.system.context.restore()}}});a.Image.cache={};a.Image.reloadCache=function(){for(path in a.Image.cache)a.Image.cache[path].reload()}});a.module("g.animation").requires("g.timer","g.image").defines(function(){a.AnimationSheet=a.Class.extend({width:8,height:8,image:null,init:function(b,c,e){this.width=c;this.height=e;this.image=new a.Image(b)}});a.Animation=a.Class.extend({sheet:null,timer:null,sequence:[],flip:{x:!1,y:!1},frame:0,tile:0,loopCount:0,alpha:1,init:function(b,
c,e,d){this.sheet=b;this.timer=new a.Timer;this.frameTime=c;this.sequence=e;this.stop=!!d},rewind:function(){this.timer.reset();this.loopCount=0;this.tile=this.sequence[0];return this},gotoFrame:function(a){this.timer.set(this.frameTime*-a);this.update()},gotoRandomFrame:function(){this.gotoFrame((Math.random()*this.sequence.length).floor())},update:function(){var a=(this.timer.delta()/this.frameTime).floor();this.loopCount=(a/this.sequence.length).floor();this.frame=this.stop&&this.loopCount>0?this.sequence.length-
1:a%this.sequence.length;this.tile=this.sequence[this.frame]},draw:function(b,c){if(!(b>a.system.width||c>a.system.height||b+this.sheet.width<0||c+this.sheet.height<0))a.system.context.globalAlpha=this.alpha,this.sheet.image.drawTile(b,c,this.tile,this.sheet.width,this.sheet.height,this.flip.x,this.flip.y,this.alpha),a.system.context.globalAlpha=1}})});a.module("g.map").defines(function(){a.Map=a.Class.extend({tilesize:8,width:1,height:1,data:[[]],init:function(a,c){this.tilesize=a;this.data=c;this.height=
c.length;this.width=c[0].length},getTile:function(a,c){var e=(a/this.tilesize).floor(),d=(c/this.tilesize).floor();return e>=0&&e<this.width&&d>=0&&d<this.height?this.data[d][e]:0},setTile:function(a,c,e){a=(a/this.tilesize).floor();c=(c/this.tilesize).floor();a>=0&&a<this.width&&c>=0&&c<this.height&&(this.data[c][a]=e)}})});a.module("g.system").requires("g.timer","g.image").defines(function(){a.System=a.Class.extend({fps:30,width:320,height:240,realWidth:320,realHeight:240,scale:1,tick:0,intervalId:0,
clock:null,newGameClass:null,running:!1,delegate:null,canvas:null,context:null,smoothPositioning:!0,_loopStarted:!1,init:function(b,c,e,d,f){this.fps=c||this.fps;this.width=e||this.width;this.height=d||this.height;this.scale=f||this.scale;this.realWidth=this.width*this.scale;this.realHeight=this.height*this.scale;this.clock=new a.Timer;this.canvas=a.$(b||"canvas");this.canvas.width=this.realWidth;this.canvas.height=this.realHeight;this.context=this.canvas.getContext("2d")},setGame:function(a){this.running?
this.newGameClass=a:this.setGameNow(a)},setGameNow:function(b){a.game=new b;a.system.setDelegate(a.game)},setDelegate:function(a){if(typeof a.run=="function")this.delegate=a,this.startRunLoop();else throw"System.setDelegate: No run() function in object";},stopRunLoop:function(){clearInterval(this.intervalId);this._loopStarted=this.running=!1;a.log("System: Main loop stopped.")},startRunLoop:function(){this.stopRunLoop();this.intervalId=setInterval(this.run.bind(this),1E3/this.fps);this.running=!0;
a.log("System: Main loop started.")},clear:function(a){this.context.fillStyle=a;this.context.fillRect(0,0,this.realWidth,this.realHeight)},run:function(){if(!this._loopStarted)this._loopStarted=!0,g.log("System.run: Just entered main loop for the first time.");a.Timer.step();this.tick=this.clock.tick();this.delegate.run();if(this.newGameClass)this.setGameNow(this.newGameClass),this.newGameClass=null},getDrawPos:function(a){return this.smoothPositioning?(a*this.scale).round():a.round()*this.scale}})});
a.module("g.background-map").requires("g.map","g.image").defines(function(){a.BackgroundMap=a.Map.extend({tiles:null,scroll:{x:0,y:0},distance:1,repeat:!1,tilesetName:"",preRender:!1,preRenderedChunks:null,chunkSize:512,debugChunks:!1,anims:{},init:function(a,c,e){this.parent(a,c);this.setTileset(e)},setTileset:function(b){this.tilesetName=b instanceof a.Image?b.path:b;this.tiles=new a.Image(this.tilesetName);this.preRenderedChunks=null},setScreenPos:function(a,c){this.scroll.x=a/this.distance;this.scroll.y=
c/this.distance},preRenderMapToChunks:function(){a.log("BackgroundMap.preRenderMapToChunks");var b=this.width*this.tilesize*a.system.scale,c=this.height*this.tilesize*a.system.scale,e=(b/this.chunkSize).ceil(),d=(c/this.chunkSize).ceil();this.preRenderedChunks=[];for(var f=0;f<d;f++){this.preRenderedChunks[f]=[];for(var i=0;i<e;i++)this.preRenderedChunks[f][i]=this.preRenderChunk(i,f,i==e-1?b-i*this.chunkSize:this.chunkSize,f==d-1?c-f*this.chunkSize:this.chunkSize)}},preRenderChunk:function(b,c,e,
d){a.log("BackgroundMap.preRenderChunk");var f=e/this.tilesize/a.system.scale+1;th=d/this.tilesize/a.system.scale+1;var i=b*this.chunkSize/a.system.scale%this.tilesize,h=c*this.chunkSize/a.system.scale%this.tilesize,b=(b*this.chunkSize/this.tilesize/a.system.scale).floor(),c=(c*this.chunkSize/this.tilesize/a.system.scale).floor(),o=a.$new("canvas");o.width=e;o.height=d;e=a.system.context;a.system.context=o.getContext("2d");for(d=0;d<f;d++)for(var k=0;k<th;k++)if(d+b<this.width&&k+c<this.height){var j=
this.data[k+c][d+b];j&&this.tiles.drawTile(d*this.tilesize-i,k*this.tilesize-h,j-1,this.tilesize)}a.system.context=e;return o},draw:function(){a.log("BackgroundMap.draw");this.tiles.loaded&&(this.preRender?this.drawPreRendered():this.drawTiled())},drawPreRendered:function(){a.log("BackgroundMap.drawPreRendered");this.preRenderedChunks||this.preRenderMapToChunks();var b=a.system.getDrawPos(this.scroll.x),c=a.system.getDrawPos(this.scroll.y);this.repeat&&(b%=this.width*this.tilesize*a.system.scale,
c%=this.height*this.tilesize*a.system.scale);var e=Math.max((b/this.chunkSize).floor(),0),d=Math.max((c/this.chunkSize).floor(),0),f=((b+a.system.realWidth)/this.chunkSize).ceil(),i=((c+a.system.realHeight)/this.chunkSize).ceil(),h=this.preRenderedChunks[0].length,o=this.preRenderedChunks.length;this.repeat||(f=Math.min(f,h),i=Math.min(i,o));for(var k=0;d<i;d++){for(var j=0,l=e;l<f;l++){var m=this.preRenderedChunks[d%o][l%h],n=-b+l*this.chunkSize-j,q=-c+d*this.chunkSize-k;a.system.context.drawImage(m,
n,q);if(this.debugChunks)a.system.context.strokeStyle="#f0f",a.system.context.strokeRect(n,q,this.chunkSize,this.chunkSize);this.repeat&&m.width<this.chunkSize&&n+m.width<a.system.realWidth&&(j=this.chunkSize-m.width,f++)}this.repeat&&m.height<this.chunkSize&&q+m.height<a.system.realHeight&&(k=this.chunkSize-m.height,i++)}},drawTiled:function(){a.log("BackgroundMap.drawTiled");for(var b=0,c=null,e=(this.scroll.x/this.tilesize).toInt(),d=(this.scroll.y/this.tilesize).toInt(),f=this.scroll.x%this.tilesize,
i=this.scroll.y%this.tilesize,h=-f-this.tilesize,f=a.system.width+this.tilesize-f,o=a.system.height+this.tilesize-i,k=-1,i=-i-this.tilesize;i<o;k++,i+=this.tilesize){var j=k+d;if(j>=this.height||j<0){if(!this.repeat)continue;j=j%this.height+(j<0?this.height:0)}for(var l=-1,m=h;m<f;l++,m+=this.tilesize){b=l+e;if(b>=this.width||b<0){if(!this.repeat)continue;b=b%this.width+(b<0?this.width:0)}if(b=this.data[j][b])(c=this.anims[b-1])?c.draw(m,i):this.tiles.drawTile(m,i,b-1,this.tilesize)}}}})});a.module("g.main").requires("dom.ready",
"g.loader","g.system").defines(function(){a.main=function(b,c,e,d,f,h,n){a.log("main(): Enter");a.system=new a.System(b,e,d,f,h||1);a.ready=!0;(new (n||a.Loader)(c||a.Game,a.resources)).load();a.log("main(): Exit")}});a.module("g.game").requires("g.main").defines(function(){a.Game=a.Class.extend({clearColor:"#000000",gravity:0,screen:{x:0,y:0},backgroundMaps:[],backgroundAnims:{},loaderBgrndImage:new a.Image("./assets/images/g-loader-bgrnd.png"),loaderSpriteImage:new a.Image("./assets/images/g-loader-sprite.png"),
homePageBgrndImage:new a.Image("./assets/images/g-homepage-bgrnd.png"),homePageSpriteImage:new a.Image("./assets/images/g-homepage-sprite.png"),playgroundImage:new a.Image("./assets/images/g-playground-bgrnd.png"),playgroundImage:new a.Image("./assets/images/g-playground-sprite.png"),run:function(){this.update();this.draw()},update:function(){},draw:function(){}})});if(typeof h!=="undefined")h.g=a})(window);Number.prototype.map=function(h,a,n,q){return n+(q-n)*((this-h)/(a-h))};
Number.prototype.limit=function(h,a){return Math.min(a,Math.max(h,this))};Number.prototype.round=function(h){h=Math.pow(10,h||0);return Math.round(this*h)/h};Number.prototype.floor=function(){return Math.floor(this)};Number.prototype.ceil=function(){return Math.ceil(this)};Number.prototype.toInt=function(){return this|0};Array.prototype.erase=function(h){for(var a=this.length;a--;)this[a]===h&&this.splice(a,1);return this};Array.prototype.random=function(){return this[(Math.random()*this.length).floor()]};
Function.prototype.bind=function(h){var a=this;return function(){var n=Array.prototype.slice.call(arguments);return a.apply(h||null,n)}};
