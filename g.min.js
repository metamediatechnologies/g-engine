/*
 Copyright 2011  Metamedia Technologies
 ------------
*/
(function(h){var b={version:"0.1",global:h,doc:h.document,game:null,modules:{},resources:[],ready:!1,baked:!1,nocache:"",ua:{},_current:null,_loadQueue:[],_waitForOnload:0,$:function(a){return a.charAt(0)=="#"?b.doc.getElementById(a.substr(1)):b.doc.getElementsByTagName(a)[0]},$new:function(a){return b.doc.createElement(a)},copy:function(a){if(!a||typeof a!="object"||a instanceof b.Class)return a;else{if(a instanceof Array)for(var c=[],d=0,e=a.length;d<e;d++)c[d]=b.copy(a[d]);else for(d in c={},a)c[d]=
b.copy(a[d]);return c}},module:function(a){if(b._current)throw"Module '"+b._current.name+"' defines nothing";b._current={name:a,requires:[],loaded:!1,body:null};b.modules[a]=b._current;b._loadQueue.push(b._current);b._initDOMReady();return b},requires:function(){b._current.requires=Array.prototype.slice.call(arguments);return b},defines:function(a){name=b._current.name;b._current.body=a;b._current=null;b._execModules()},addResource:function(a){b.resources.push(a)},setNocache:function(a){b.nocache=
a?"?"+Math.random().toString().substr(2):""},_loadScript:function(a,c){b.modules[a]={name:a,requires:[],loaded:!1,body:null};b._waitForOnload++;var d="lib/"+a+".js"+b.nocache,e=b.$new("script");e.type="text/javascript";e.src=d;e.onload=function(){b._waitForOnload--;b._execModules()};e.onerror=function(){throw"Failed to load module "+a+" at "+d+" required from "+c;};b.$("head").appendChild(e)},_execModules:function(){for(var a=!1,c=0;c<b._loadQueue.length;c++){for(var d=b._loadQueue[c],e=!0,f=0;f<
d.requires.length;f++){var g=d.requires[f];b.modules[g]?b.modules[g].loaded||(e=!1):(e=!1,b._loadScript(g,d.name))}if(e&&d.body)b._loadQueue.splice(c,1),d.loaded=!0,d.body(),a=!0,c--}if(a)b._execModules();else if(!b.baked&&b._waitForOnload==0&&b._loadQueue.length!=0){a=[];for(c=0;c<b._loadQueue.length;c++)a.push(b._loadQueue[c].name);throw"Unresolved (circular?) dependencies: "+a.join(", ");}},_DOMReady:function(){if(!b.modules["dom.ready"].loaded){if(!b.doc.body)return setTimeout(b._DOMReady,13);
b.modules["dom.ready"].loaded=!0;b._waitForOnload--;b._execModules()}return 0},_isCanvas:function(){var a=b.doc.createElement("canvas");return!(!a.getContext||!a.getContext("2d"))},_boot:function(){b.doc.location.href.match(/\?nocache/)&&b.setNocache(!0);b.ua.iPhone=/iPhone/i.test(navigator.userAgent);b.ua.iPhone4=b.ua.iPhone&&h.devicePixelRatio==2;b.ua.iPad=/iPad/i.test(navigator.userAgent);b.ua.android=/android/i.test(navigator.userAgent);b.ua.iOS=b.ua.iPhone||b.ua.iPad;b.ua.mobile=b.ua.iOS||b.ua.android;
b.ua.desktop=!b.ua.mobile;b.ua.webkit=/(webkit)[ \/]([\w.]+)/i.test(navigator.userAgent);b.ua.opera=/(opera)(?:.*version)?[ \/]([\w.]+)/i.test(navigator.userAgent);b.ua.msie=/(msie) ([\w.]+)/i.test(navigator.userAgent);b.ua.mozilla=/(mozilla)(?:.*? rv:([\w.]+))?/i.test(navigator.userAgent);b.ua.chrome=/(chrome)[ \/]([\w.]+)/i.test(navigator.userAgent)},_initDOMReady:function(){b.modules["dom.ready"]||(b._boot(),b.modules["dom.ready"]={requires:[],loaded:!1,body:null},b._waitForOnload++,b.doc.readyState===
"complete"?b._DOMReady():(b.doc.addEventListener("DOMContentLoaded",b._DOMReady,!1),h.addEventListener("load",b._DOMReady,!1)))},log:function(a){typeof console!=="undefined"&&console.log(a)}},n=!1,o=/xyz/.test(function(){xyz()})?/\bparent\b/:/.*/;b.Class=function(){};var q=function(a){var b=this.prototype,d={},e;for(e in a)typeof a[e]=="function"&&typeof b[e]=="function"&&o.test(a[e])?(d[e]=b[e],b[e]=function(a,b){return function(){var c=this.parent;this.parent=d[a];var e=b.apply(this,arguments);
this.parent=c;return e}}(e,a[e])):b[e]=a[e]};b.Class.extend=function(a){function c(){if(!n){if(this.staticInstantiate){var a=this.staticInstantiate.apply(this,arguments);if(a)return a}for(var c in this)typeof this[c]=="object"&&(this[c]=b.copy(this[c]));this.init&&this.init.apply(this,arguments)}return this}var d=this.prototype;n=!0;var e=new this;n=!1;for(var f in a)e[f]=typeof a[f]=="function"&&typeof d[f]=="function"&&o.test(a[f])?function(a,b){return function(){var c=this.parent;this.parent=d[a];
var e=b.apply(this,arguments);this.parent=c;return e}}(f,a[f]):a[f];c.prototype=e;c.constructor=c;c.extend=arguments.callee;c.inject=q;return c};b.module("g.timer").defines(function(){b.Timer=b.Class.extend({target:0,base:0,last:0,init:function(a){this.last=this.base=b.Timer.time;this.target=a||0},set:function(a){this.target=a||0;this.base=b.Timer.time},reset:function(){this.base=b.Timer.time},tick:function(){var a=b.Timer.time-this.last;this.last=b.Timer.time;return a},delta:function(){return b.Timer.time-
this.base-this.target}});b.Timer._last=0;b.Timer.time=0;b.Timer.timeScale=1;b.Timer.maxStep=0.05;b.Timer.step=function(){var a=Date.now();b.Timer.time+=Math.min((a-b.Timer._last)/1E3,b.Timer.maxStep)*b.Timer.timeScale;b.Timer._last=a}});b.module("g.image").defines(function(){b.Image=b.Class.extend({data:null,width:0,height:0,loaded:!1,failed:!1,loadCallback:null,path:"",staticInstantiate:function(a){return b.Image.cache[a]||null},init:function(a){this.path=a;this.load()},load:function(a){this.loaded?
a&&a(this.path,!0):(!this.loaded&&b.ready?(this.loadCallback=a||null,this.data=new Image,this.data.onload=this.onload.bind(this),this.data.onerror=this.onerror.bind(this),this.data.src=this.path+b.nocache):b.addResource(this),b.Image.cache[this.path]=this)},reload:function(){this.loaded=!1;this.data=new Image;this.data.onload=this.onload.bind(this);this.data.src=this.path+"?"+Math.random()},onload:function(){this.width=this.data.width;this.height=this.data.height;b.system.scale!=1&&this.resize(b.system.scale);
this.loaded=!0;this.loadCallback&&this.loadCallback(this.path,!0)},onerror:function(){this.failed=!0;this.loadCallback&&this.loadCallback(this.path,!1)},resize:function(a){var c=this.width*a,d=this.height*a,e=b.$new("canvas");e.width=this.width;e.height=this.height;e=e.getContext("2d");e.drawImage(this.data,0,0,this.width,this.height,0,0,this.width,this.height);var e=e.getImageData(0,0,this.width,this.height),f=b.$new("canvas");f.width=c;f.height=d;for(var g=f.getContext("2d"),i=g.getImageData(0,
0,c,d),l=0;l<d;l++)for(var k=0;k<c;k++){var j=((l/a).floor()*this.width+(k/a).floor())*4,m=(l*c+k)*4;i.data[m]=e.data[j];i.data[m+1]=e.data[j+1];i.data[m+2]=e.data[j+2];i.data[m+3]=e.data[j+3]}g.putImageData(i,0,0);this.data=f},draw:function(a,c,d,e,f,g){if(this.loaded){var i=b.system.scale,f=(f?f:this.width)*i,g=(g?g:this.height)*i;b.system.context.drawImage(this.data,d?d*i:0,e?e*i:0,f,g,b.system.getDrawPos(a),b.system.getDrawPos(c),f,g)}},drawTile:function(a,c,d,e,f,g,i){f=f?f:e;if(this.loaded&&
!(e>this.width||f>this.height)){var l=b.system.scale,k=e*l,j=f*l,m=g?-1:1,h=i?-1:1;if(g||i)b.system.context.save(),b.system.context.scale(m,h);b.system.context.drawImage(this.data,(d*e).floor()%this.width*l,(d*e/this.width).floor()*f*l,k,j,b.system.getDrawPos(a)*m-(g?k:0),b.system.getDrawPos(c)*h-(i?j:0),k,j);(g||i)&&b.system.context.restore()}}});b.Image.cache={};b.Image.reloadCache=function(){for(path in b.Image.cache)b.Image.cache[path].reload()}});b.module("g.font").requires("g.image").defines(function(){b.Font=
b.Image.extend({widthMap:[],indices:[],firstChar:32,onload:function(a){this._loadMetrics(this.data);this.parent(a)},draw:function(a,c,d,e){typeof a!="string"&&(a=a.toString());if(e==b.Font.ALIGN.RIGHT||e==b.Font.ALIGN.CENTER){for(var f=0,g=0;g<a.length;g++){var i=a.charCodeAt(g);f+=this.widthMap[i-this.firstChar]+1}c-=e==b.Font.ALIGN.CENTER?f/2:f}for(g=0;g<a.length;g++)i=a.charCodeAt(g),c+=this._drawChar(i-this.firstChar,c,d)},_drawChar:function(a,c,d){if(!this.loaded||a<0||a>=this.indices.length)return 0;
var e=b.system.scale,f=this.widthMap[a]*e,g=(this.height-2)*e;b.system.context.drawImage(this.data,this.indices[a]*e,0,f,g,b.system.getDrawPos(c),b.system.getDrawPos(d),f,g);return this.widthMap[a]+1},_loadMetrics:function(a){this.widthMap=[];this.indices=[];var c=b.$new("canvas");c.width=a.width;c.height=1;c=c.getContext("2d");c.drawImage(a,0,a.height-1,a.width,1,0,0,a.width,1);for(var c=c.getImageData(0,0,a.width,1),d=0,e=0,f=0;f<a.width;f++){var g=f*4+3;c.data[g]!=0?e++:c.data[g]==0&&e&&(this.widthMap.push(e),
this.indices.push(f-e),d++,e=0)}this.widthMap.push(e);this.indices.push(f-e)}});b.Font.ALIGN={LEFT:0,RIGHT:1,CENTER:2}});b.module("g.sound").defines(function(){b.SoundManager=b.Class.extend({clips:{},volume:1,channels:4,format:"mp3",init:function(){this.format=b.$new("audio").canPlayType("audio/mpeg")?"mp3":"ogg"},load:function(a,c,d){if(this.clips[a]){if(c&&this.clips[a].length<this.channels)for(c=this.clips[a].length;c<this.channels;c++)this.clips[a].push(this.clips[a][0].cloneNode(!0));return this.clips[a][0]}var e=
a.match(/^(.*)\.\w+$/)[1]+"."+this.format+b.nocache,f=b.$new("audio");d&&(f.addEventListener("canplaythrough",function(b){this.removeEventListener("canplaythrough",arguments.callee,!1);d(a,!0,b)},!1),f.addEventListener("error",function(b){d(a,!0,b)},!1));f.autobuffer=!0;f.preload="auto";f.src=e;f.load();this.clips[a]=[f];if(c)for(c=1;c<this.channels;c++)this.clips[a].push(f.cloneNode(!0));return f},get:function(a){for(var a=this.clips[a],b=0,d;d=a[b++];)if(d.paused||d.ended){if(d.ended)d.currentTime=
0;return d}a[0].pause();a[0].currentTime=0;return a[0]}});b.Music=b.Class.extend({tracks:[],currentTrack:null,currentIndex:0,random:!1,_volume:1,_loop:!1,_fadeInterval:0,_fadeTimer:null,_endedCallbackBound:null,init:function(){this._endedCallbackBound=this._endedCallback.bind(this);Object.defineProperty?(Object.defineProperty(this,"volume",{get:this.getVolume.bind(this),set:this.setVolume.bind(this)}),Object.defineProperty(this,"loop",{get:this.getLooping.bind(this),set:this.setLooping.bind(this)})):
this.__defineGetter__&&(this.__defineGetter__("volume",this.getVolume.bind(this)),this.__defineSetter__("volume",this.setVolume.bind(this)),this.__defineGetter__("loop",this.getLooping.bind(this)),this.__defineSetter__("loop",this.setLooping.bind(this)))},add:function(a){if(b.Sound.enabled&&(a=b.soundManager.load(a instanceof b.Sound?a.path:a,!1),a.loop=this._loop,a.volume=this._volume,a.addEventListener("ended",this._endedCallbackBound,!1),this.tracks.push(a),!this.currentTrack))this.currentTrack=
a},next:function(){if(this.tracks.length)this.stop(),this.currentIndex=this.random?(Math.random()*this.tracks.length).floor():(this.currentIndex+1)%this.tracks.length,this.currentTrack=this.tracks[this.currentIndex],this.play()},pause:function(){this.currentTrack&&this.currentTrack.pause()},stop:function(){if(this.currentTrack)this.currentTrack.pause(),this.currentTrack.currentTime=0},play:function(){this.currentTrack&&this.currentTrack.play()},getLooping:function(){return this._loop},setLooping:function(a){this._loop=
a;for(var b in this.tracks)this.tracks[b].loop=a},getVolume:function(){return this._volume},setVolume:function(a){this._volume=a.limit(0,1);for(var b in this.tracks)this.tracks[b].volume=this._volume},fadeOut:function(a){if(this.currentTrack)clearInterval(this._fadeInterval),this.fadeTimer=new b.Timer(a),this._fadeInterval=setInterval(this._fadeStep.bind(this),50)},_fadeStep:function(){var a=this.fadeTimer.delta().map(-this.fadeTimer.target,0,1,0).limit(0,1)*this._volume;a<=0.01?(this.stop(),this.currentTrack.volume=
this._volume,clearInterval(this._fadeInterval)):this.currentTrack.volume=a},_endedCallback:function(){this._loop?this.play():this.next()}});b.Sound=b.Class.extend({path:"",volume:1,currentClip:null,multiChannel:!0,init:function(a,b){this.path=a;this.multiChannel=b!==!1;this.load()},load:function(a){b.Sound.enabled?b.ready?b.soundManager.load(this.path,this.multiChannel,a):b.addResource(this):a&&a(this.path,!0)},play:function(){if(b.Sound.enabled)this.currentClip=b.soundManager.get(this.path),this.currentClip.volume=
b.soundManager.volume*this.volume,this.currentClip.play()},stop:function(){if(this.currentClip)this.currentClip.pause(),this.currentClip.currentTime=0}});b.Sound.enabled=!0});b.module("g.input").defines(function(){b.KEY={MOUSE1:-1,MOUSE2:-3,MWHEEL_UP:-4,MWHEEL_DOWN:-5,BACKSPACE:8,TAB:9,ENTER:13,PAUSE:19,CAPS:20,ESC:27,SPACE:32,PAGE_UP:33,PAGE_DOWN:34,END:35,HOME:36,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,INSERT:45,DELETE:46,0:48,1:49,2:50,3:51,4:52,5:53,6:54,7:55,8:56,9:57,A:65,B:66,
C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90,NUMPAD_0:96,NUMPAD_1:97,NUMPAD_2:98,NUMPAD_3:99,NUMPAD_4:100,NUMPAD_5:101,NUMPAD_6:102,NUMPAD_7:103,NUMPAD_8:104,NUMPAD_9:105,MULTIPLY:106,ADD:107,SUBSTRACT:109,DECIMAL:110,DIVIDE:111,F1:112,F2:113,F3:114,F4:115,F5:116,F6:117,F7:118,F8:119,F9:120,F10:121,F11:122,F12:123,SHIFT:16,CTRL:17,ALT:18,PLUS:187,COMMA:188,MINUS:189,PERIOD:190};b.Input=b.Class.extend({bindings:{},actions:{},
presses:{},locks:{},delayedKeyup:[],isUsingMouse:!1,isUsingKeyboard:!1,isUsingAccelerometer:!1,mouse:{x:0,y:0},initMouse:function(){if(!this.isUsingMouse)this.isUsingMouse=!0,h.addEventListener("mousewheel",this.mousewheel.bind(this),!1),b.system.canvas.addEventListener("contextmenu",this.contextmenu.bind(this),!1),b.system.canvas.addEventListener("mousedown",this.keydown.bind(this),!1),b.system.canvas.addEventListener("mouseup",this.keyup.bind(this),!1),b.system.canvas.addEventListener("mousemove",
this.mousemove.bind(this),!1),b.system.canvas.addEventListener("touchstart",this.keydown.bind(this),!1),b.system.canvas.addEventListener("touchend",this.keyup.bind(this),!1),b.system.canvas.addEventListener("touchmove",this.mousemove.bind(this),!1)},initKeyboard:function(){if(!this.isUsingKeyboard)this.isUsingKeyboard=!0,h.addEventListener("keydown",this.keydown.bind(this),!1),h.addEventListener("keyup",this.keyup.bind(this),!1)},initAccelerometer:function(){this.isUsingAccelerometer||h.addEventListener("devicemotion",
this.devicemotion.bind(this),!1)},mousewheel:function(a){var c=this.bindings[a.wheel>0?b.KEY.MWHEEL_UP:b.KEY.MWHEEL_DOWN];c&&(this.actions[c]=!0,this.presses[c]=!0,a.stopPropagation(),this.delayedKeyup.push(c))},mousemove:function(a){for(var c=b.system.canvas,d={left:0,top:0};c!=null;)d.left+=c.offsetLeft,d.top+=c.offsetTop,c=c.offsetParent;var c=a.pageX,e=a.pageY;if(a.touches)c=a.touches[0].clientX,e=a.touches[0].clientY;this.mouse.x=(c-d.left)/b.system.scale;this.mouse.y=(e-d.top)/b.system.scale},
contextmenu:function(a){this.bindings[b.KEY.MOUSE2]&&(a.stopPropagation(),a.preventDefault())},keydown:function(a){if(a.target.type!="text"){var c=this.bindings[a.type=="keydown"?a.keyCode:a.button==2?b.KEY.MOUSE2:b.KEY.MOUSE1];c&&(this.actions[c]=!0,a.stopPropagation(),a.preventDefault())}},keyup:function(a){if(a.target.type!="text"){var c=this.bindings[a.type=="keyup"?a.keyCode:a.button==2?b.KEY.MOUSE2:b.KEY.MOUSE1];c&&(this.delayedKeyup.push(c),a.stopPropagation(),a.preventDefault())}},bind:function(a,
b){a<0?this.initMouse():a>0&&this.initKeyboard();this.bindings[a]=b},bindTouch:function(a,c){var d=b.$(a),e=this;d.addEventListener("touchstart",function(a){e.touchStart(a,c)},!1);d.addEventListener("touchend",function(a){e.touchEnd(a,c)},!1)},unbind:function(a){this.bindings[a]=null},unbindAll:function(){this.bindings=[]},state:function(a){return this.actions[a]},pressed:function(a){return!this.locks[a]&&this.actions[a]?this.locks[a]=!0:!1},clearPressed:function(){for(var a=0;a<this.delayedKeyup.length;a++){var b=
this.delayedKeyup[a];this.locks[b]=!1;this.actions[b]=!1}this.delayedKeyup=[]},touchStart:function(a,b){this.actions[b]=!0;a.stopPropagation();a.preventDefault();return!1},touchEnd:function(a,b){this.delayedKeyup.push(b);a.stopPropagation();a.preventDefault();return!1}})});b.module("g.loader").requires("g.image","g.font","g.sound").defines(function(){b.Loader=b.Class.extend({resources:[],gameClass:null,status:0,done:!1,_unloaded:[],_drawStatus:0,_intervalId:0,_loadCallbackBound:null,init:function(a,
b){this.gameClass=a;this.resources=b;this._loadCallbackBound=this._loadCallback.bind(this);for(var d=0;d<this.resources.length;d++)this._unloaded.push(this.resources[d].path)},load:function(){b.system.clear("#000");if(this.resources.length){for(var a=0;a<this.resources.length;a++)this.loadResource(this.resources[a]);this._intervalId=setInterval(this.draw.bind(this),16)}else this.end()},loadResource:function(a){a.load(this._loadCallbackBound)},end:function(){if(!this.done)this.done=!0,clearInterval(this._intervalId),
b.system.setGame(this.gameClass)},draw:function(){this._drawStatus+=(this.status-this._drawStatus)/5;var a=b.system.scale,c=b.system.width*0.6,d=b.system.height*0.1,e=b.system.width*0.5-c/2,f=b.system.height*0.5-d/2;b.system.context.fillStyle="#000";b.system.context.fillRect(0,0,480,320);b.system.context.fillStyle="#fff";b.system.context.fillRect(e*a,f*a,c*a,d*a);b.system.context.fillStyle="#000";b.system.context.fillRect(e*a+a,f*a+a,c*a-a-a,d*a-a-a);b.system.context.fillStyle="#fff";b.system.context.fillRect(e*
a,f*a,c*a*this._drawStatus,d*a)},_loadCallback:function(a,b){if(b)this.status=1-this._unloaded.length/this.resources.length,this.draw(),this._unloaded.erase(a);else throw"Failed to load resource: "+a;this.status=1-this._unloaded.length/this.resources.length;this._unloaded.length==0&&setTimeout(this.end.bind(this),250)}})});b.module("g.background").requires("g.image").defines(function(){b.Background=b.Class.extend({image:null,coordinates:{targetX:0,targetY:0,sourceX:0,sourceY:0},preRender:!1,preRenderedChunks:null,
chunkSize:512,debugChunks:!1,init:function(a,b,d,e,f){this.coordinates.targetX=a;this.coordinates.targetY=b;this.coordinates.sourceX=d;this.coordinates.sourceY=e;this.image=f},draw:function(){typeof this.image!=="undefined"&&this.image.loaded&&this.image.draw(this.coordinates.targetX,this.coordinates.targetY,this.coordinates.sourceX,this.coordinates.sourceY,this.image.width,this.image.height)}})});b.module("g.map").defines(function(){b.Map=b.Class.extend({tilesize:8,width:1,height:1,data:[[]],init:function(a,
b){this.tilesize=a;this.data=b;this.height=b.length;this.width=b[0].length},getTile:function(a,b){var d=(a/this.tilesize).floor(),e=(b/this.tilesize).floor();return d>=0&&d<this.width&&e>=0&&e<this.height?this.data[e][d]:0},setTile:function(a,b,d){a=(a/this.tilesize).floor();b=(b/this.tilesize).floor();a>=0&&a<this.width&&b>=0&&b<this.height&&(this.data[b][a]=d)}})});b.module("g.background-map").requires("g.map","g.image").defines(function(){b.BackgroundMap=b.Map.extend({tiles:null,scroll:{x:0,y:0},
distance:1,repeat:!1,tilesetName:"",preRender:!1,preRenderedChunks:null,chunkSize:512,debugChunks:!1,anims:{},init:function(a,b,d){this.parent(a,b);this.setTileset(d)},setTileset:function(a){this.tilesetName=a instanceof b.Image?a.path:a;this.tiles=new b.Image(this.tilesetName);this.preRenderedChunks=null},setScreenPos:function(a,b){this.scroll.x=a/this.distance;this.scroll.y=b/this.distance},preRenderMapToChunks:function(){var a=this.width*this.tilesize*b.system.scale,c=this.height*this.tilesize*
b.system.scale,d=(a/this.chunkSize).ceil(),e=(c/this.chunkSize).ceil();this.preRenderedChunks=[];for(var f=0;f<e;f++){this.preRenderedChunks[f]=[];for(var g=0;g<d;g++)this.preRenderedChunks[f][g]=this.preRenderChunk(g,f,g==d-1?a-g*this.chunkSize:this.chunkSize,f==e-1?c-f*this.chunkSize:this.chunkSize)}},preRenderChunk:function(a,c,d,e){b.log("BackgroundMap.preRenderChunk");var f=d/this.tilesize/b.system.scale+1;th=e/this.tilesize/b.system.scale+1;var g=a*this.chunkSize/b.system.scale%this.tilesize,
i=c*this.chunkSize/b.system.scale%this.tilesize,a=(a*this.chunkSize/this.tilesize/b.system.scale).floor(),c=(c*this.chunkSize/this.tilesize/b.system.scale).floor(),l=b.$new("canvas");l.width=d;l.height=e;d=b.system.context;b.system.context=l.getContext("2d");for(e=0;e<f;e++)for(var k=0;k<th;k++)if(e+a<this.width&&k+c<this.height){var j=this.data[k+c][e+a];j&&this.tiles.drawTile(e*this.tilesize-g,k*this.tilesize-i,j-1,this.tilesize)}b.system.context=d;return l},draw:function(){this.tiles.loaded&&(this.preRender?
this.drawPreRendered():this.drawTiled())},drawPreRendered:function(){this.preRenderedChunks||this.preRenderMapToChunks();var a=b.system.getDrawPos(this.scroll.x),c=b.system.getDrawPos(this.scroll.y);this.repeat&&(a%=this.width*this.tilesize*b.system.scale,c%=this.height*this.tilesize*b.system.scale);var d=Math.max((a/this.chunkSize).floor(),0),e=Math.max((c/this.chunkSize).floor(),0),f=((a+b.system.realWidth)/this.chunkSize).ceil(),g=((c+b.system.realHeight)/this.chunkSize).ceil(),i=this.preRenderedChunks[0].length,
l=this.preRenderedChunks.length;this.repeat||(f=Math.min(f,i),g=Math.min(g,l));for(var k=0;e<g;e++){for(var j=0,h=d;h<f;h++){var p=this.preRenderedChunks[e%l][h%i],n=-a+h*this.chunkSize-j,o=-c+e*this.chunkSize-k;b.system.context.drawImage(p,n,o);if(this.debugChunks)b.system.context.strokeStyle="#f0f",b.system.context.strokeRect(n,o,this.chunkSize,this.chunkSize);this.repeat&&p.width<this.chunkSize&&n+p.width<b.system.realWidth&&(j=this.chunkSize-p.width,f++)}this.repeat&&p.height<this.chunkSize&&
o+p.height<b.system.realHeight&&(k=this.chunkSize-p.height,g++)}},drawTiled:function(){for(var a=0,c=null,d=(this.scroll.x/this.tilesize).toInt(),e=(this.scroll.y/this.tilesize).toInt(),f=this.scroll.x%this.tilesize,g=this.scroll.y%this.tilesize,i=-f-this.tilesize,f=b.system.width+this.tilesize-f,l=b.system.height+this.tilesize-g,k=-1,g=-g-this.tilesize;g<l;k++,g+=this.tilesize){var j=k+e;if(j>=this.height||j<0){if(!this.repeat)continue;j=j%this.height+(j<0?this.height:0)}for(var h=-1,n=i;n<f;h++,
n+=this.tilesize){a=h+d;if(a>=this.width||a<0){if(!this.repeat)continue;a=a%this.width+(a<0?this.width:0)}if(a=this.data[j][a])(c=this.anims[a-1])?c.draw(n,g):this.tiles.drawTile(n,g,a-1,this.tilesize)}}}})});b.module("g.collision-map").requires("g.map").defines(function(){b.CollisionMap=b.Map.extend({firstSolidTile:1,lastSolidTile:255,init:function(a,b){this.parent(a,b)},trace:function(a,b,d,e,f){var g={collision:{x:!1,y:!1},pos:{x:a,y:b},tile:{x:0,y:0}},i=(Math.max(Math.abs(d),Math.abs(e))/this.tilesize).ceil();
if(i>1){d/=i;e/=i;for(var l=0;l<i&&(d||e);l++)this._traceStep(g,a,b,d,e,f,objectHeight),a=g.pos.x,b=g.pos.y,g.collision.x&&(d=0),g.collision.y&&(e=0)}else this._traceStep(g,a,b,d,e,f,objectHeight);return g},_traceStep:function(a,b,d,e,f,g,i){a.pos.x+=e;a.pos.y+=f;if(e){var l=e>0?g:0,h=e<0?this.tilesize:0,j=(d/this.tilesize).floor(),m=((d+i)/this.tilesize).ceil(),b=((b+e+l)/this.tilesize).floor();if(m>=0&&j<this.height&&b>=0&&b<this.width)for(;j<m;j++)if(e=this.data[j]&&this.data[j][b],e>=this.firstSolidTile&&
e<=this.lastSolidTile){a.collision.x=!0;a.tile.x=e;a.pos.x=b*this.tilesize-l+h;break}}if(f&&(i=f>0?i:0,l=f<0?this.tilesize:0,b=(a.pos.x/this.tilesize).floor(),g=((a.pos.x+g)/this.tilesize).ceil(),j=((d+f+i)/this.tilesize).floor(),g>=0&&b<this.width&&j>=0&&j<this.height))for(;b<g;b++)if(e=this.data[j]&&this.data[j][b],e>=this.firstSolidTile&&e<=this.lastSolidTile){a.collision.y=!0;a.tile.y=e;a.pos.y=j*this.tilesize-i+l;break}}});b.CollisionMap.staticNoCollision={trace:function(a,b,d,e){return{collision:{x:!1,
y:!1},pos:{x:a+d,y:b+e},tile:{x:0,y:0}}}}});b.module("g.animation").requires("g.timer","g.image").defines(function(){b.AnimationSheet=b.Class.extend({width:8,height:8,image:null,init:function(a,c,d){this.width=c;this.height=d;this.image=new b.Image(a)}});b.Animation=b.Class.extend({sheet:null,timer:null,sequence:[],flip:{x:!1,y:!1},frame:0,tile:0,loopCount:0,alpha:1,init:function(a,c,d,e){this.sheet=a;this.timer=new b.Timer;this.frameTime=c;this.sequence=d;this.stop=!!e},rewind:function(){this.timer.reset();
this.loopCount=0;this.tile=this.sequence[0];return this},gotoFrame:function(a){this.timer.set(this.frameTime*-a);this.update()},gotoRandomFrame:function(){this.gotoFrame((Math.random()*this.sequence.length).floor())},update:function(){var a=(this.timer.delta()/this.frameTime).floor();this.loopCount=(a/this.sequence.length).floor();this.frame=this.stop&&this.loopCount>0?this.sequence.length-1:a%this.sequence.length;this.tile=this.sequence[this.frame]},draw:function(a,c){if(!(a>b.system.width||c>b.system.height||
a+this.sheet.width<0||c+this.sheet.height<0))b.system.context.globalAlpha=this.alpha,this.sheet.image.drawTile(a,c,this.tile,this.sheet.width,this.sheet.height,this.flip.x,this.flip.y,this.alpha),b.system.context.globalAlpha=1}})});b.module("g.system").requires("g.timer","g.image").defines(function(){b.System=b.Class.extend({fps:30,width:320,height:240,realWidth:320,realHeight:240,scale:1,tick:0,intervalId:0,clock:null,newGameClass:null,running:!1,delegate:null,canvas:null,context:null,smoothPositioning:!0,
_loopStarted:!1,init:function(a,c,d,e,f){this.fps=c||this.fps;this.width=d||this.width;this.height=e||this.height;this.scale=f||this.scale;this.realWidth=this.width*this.scale;this.realHeight=this.height*this.scale;this.clock=new b.Timer;this.canvas=b.$(a||"canvas");this.canvas.width=this.realWidth;this.canvas.height=this.realHeight;this.context=this.canvas.getContext("2d")},setGame:function(a){this.running?this.newGameClass=a:this.setGameNow(a)},setGameNow:function(a){b.game=new a;b.system.setDelegate(b.game)},
setDelegate:function(a){if(typeof a.run=="function")this.delegate=a,this.startRunLoop();else throw"System.setDelegate: No run() function in object";},stopRunLoop:function(){clearInterval(this.intervalId);this._loopStarted=this.running=!1;b.log("System: Main loop stopped.")},startRunLoop:function(){this.stopRunLoop();this.intervalId=setInterval(this.run.bind(this),1E3/this.fps);this.running=!0;b.log("System: Main loop started.")},clear:function(a){this.context.fillStyle=a;this.context.fillRect(0,0,
this.realWidth,this.realHeight)},run:function(){if(!this._loopStarted)this._loopStarted=!0,b.log("System.run: Just entered main loop for the first time.");b.Timer.step();this.tick=this.clock.tick();this.delegate.run();if(this.newGameClass)this.setGameNow(this.newGameClass),this.newGameClass=null},getDrawPos:function(a){return this.smoothPositioning?(a*this.scale).round():a.round()*this.scale}})});b.module("g.main").requires("dom.ready","g.loader","g.system").defines(function(){b.main=function(a,c,
d,e,f,g,i){b.log("main(): Enter");b.system=new b.System(a,d,e,f,g||1);b.input=new b.Input;b.ready=!0;(new (i||b.Loader)(c||b.Game,b.resources)).load();b.log("main(): Exit")}});b.module("g.entity").requires("g.animation","g.main").defines(function(){b.Entity=b.Class.extend({id:0,settings:{},size:{x:16,y:16},offset:{x:0,y:0},pos:{x:0,y:0},last:{x:0,y:0},vel:{x:0,y:0},accel:{x:0,y:0},friction:{x:0,y:0},maxVel:{x:100,y:100},zIndex:0,gravityFactor:1,standing:!1,bounciness:0,minBounceVelocity:40,anims:{},
animSheet:null,currentAnim:null,health:10,type:0,checkAgainst:0,collides:0,init:function(a,c,d){this.id=++b.Entity._lastId;this.pos.x=a;this.pos.y=c;b.merge(this,d)},addAnim:function(a,c,d,e){if(!this.animSheet)throw"No animSheet to add the animation "+a+" to.";c=new b.Animation(this.animSheet,c,d,e);this.anims[a]=c;if(!this.currentAnim)this.currentAnim=c;return c},update:function(){this.last.x=this.pos.x;this.last.y=this.pos.y;this.vel.y+=b.game.gravity*b.system.tick*this.gravityFactor;this.vel.x=
this.getNewVelocity(this.vel.x,this.accel.x,this.friction.x,this.maxVel.x);this.vel.y=this.getNewVelocity(this.vel.y,this.accel.y,this.friction.y,this.maxVel.y);this.handleMovementTrace(b.game.collisionMap.trace(this.pos.x,this.pos.y,this.vel.x*b.system.tick,this.vel.y*b.system.tick,this.size.x,this.size.y));this.currentAnim&&this.currentAnim.update()},getNewVelocity:function(a,c,d,e){if(c)return(a+c*b.system.tick).limit(-e,e);else if(d)return c=d*b.system.tick,a-c>0?a-c:a+c<0?a+c:0;return a.limit(-e,
e)},handleMovementTrace:function(a){this.standing=!1;if(a.collision.y)if(this.bounciness>0&&Math.abs(this.vel.y)>this.minBounceVelocity)this.vel.y*=-this.bounciness;else{if(this.vel.y>0)this.standing=!0;this.vel.y=0}if(a.collision.x)this.bounciness>0&&Math.abs(this.vel.x)>this.minBounceVelocity?this.vel.x*=-this.bounciness:this.vel.x=0;this.pos=a.pos},draw:function(){this.currentAnim&&this.currentAnim.draw(this.pos.x.round()-this.offset.x-b.game.screen.x,this.pos.y.round()-this.offset.y-b.game.screen.y)},
kill:function(){b.game.removeEntity(this)},receiveDamage:function(a){this.health-=a;this.health<=0&&this.kill()},touches:function(a){return!(this.pos.x>a.pos.x+a.size.x||this.pos.x+this.size.x<a.pos.x||this.pos.y>a.pos.y+a.size.y||this.pos.y+this.size.y<a.pos.y)},distanceTo:function(a){var b=this.pos.x+this.size.x/2-(a.pos.x+a.size.x/2),a=this.pos.y+this.size.y/2-(a.pos.y+a.size.y/2);return Math.sqrt(b*b+a*a)},angleTo:function(a){return Math.atan2(a.pos.y+a.size.y/2-(this.pos.y+this.size.y/2),a.pos.x+
a.size.x/2-(this.pos.x+this.size.x/2))},check:function(){},collideWith:function(){}});b.Entity._lastId=0;b.Entity.COLLIDES={NEVER:0,LITE:1,PASSIVE:2,ACTIVE:4,FIXED:8};b.Entity.TYPE={NONE:0,A:1,B:2,BOTH:3};b.Entity.checkPair=function(a,c){a.checkAgainst&c.type&&a.check(c);c.checkAgainst&a.type&&c.check(a);a.collides&&c.collides&&a.collides+c.collides>b.Entity.COLLIDES.ACTIVE&&b.Entity.solveCollision(a,c)};b.Entity.solveCollision=function(a,c){var d=null;if(a.collides==b.Entity.COLLIDES.LITE||c.collides==
b.Entity.COLLIDES.FIXED)d=a;else if(c.collides==b.Entity.COLLIDES.LITE||a.collides==b.Entity.COLLIDES.FIXED)d=c;a.last.x+a.size.x>c.last.x&&a.last.x<c.last.x+c.size.x?(a.last.y<c.last.y?b.Entity.seperateOnYAxis(a,c,d):b.Entity.seperateOnYAxis(c,a,d),a.collideWith(c,"y"),c.collideWith(a,"y")):a.last.y+a.size.y>c.last.y&&a.last.y<c.last.y+c.size.y&&(a.last.x<c.last.x?b.Entity.seperateOnXAxis(a,c,d):b.Entity.seperateOnXAxis(c,a,d),a.collideWith(c,"x"),c.collideWith(a,"x"))};b.Entity.seperateOnXAxis=
function(a,c,d){var e=a.pos.x+a.size.x-c.pos.x;d?(d.vel.x=-d.vel.x*d.bounciness+(a===d?c:a).vel.x,c=b.game.collisionMap.trace(d.pos.x,d.pos.y,d==a?-e:e,0,d.size.x,d.size.y),d.pos.x=c.pos.x):(d=(a.vel.x-c.vel.x)/2,a.vel.x=-d,c.vel.x=d,d=b.game.collisionMap.trace(a.pos.x,a.pos.y,-e/2,0,a.size.x,a.size.y),a.pos.x=d.pos.x.floor(),a=b.game.collisionMap.trace(c.pos.x,c.pos.y,e/2,0,c.size.x,c.size.y),c.pos.x=a.pos.x.ceil())};b.Entity.seperateOnYAxis=function(a,c,d){var e=a.pos.y+a.size.y-c.pos.y;if(d){c=
a===d?c:a;d.vel.y=-d.vel.y*d.bounciness+c.vel.y;var f=0;if(d==a&&Math.abs(d.vel.y-c.vel.y)<d.minBounceVelocity)d.standing=!0,f=c.vel.x*b.system.tick;a=b.game.collisionMap.trace(d.pos.x,d.pos.y,f,d==a?-e:e,d.size.x,d.size.y);d.pos.y=a.pos.y;d.pos.x=a.pos.x}else c.standing||a.vel.y>0?(d=b.game.collisionMap.trace(a.pos.x,a.pos.y,0,-(a.pos.y+a.size.y-c.pos.y),a.size.x,a.size.y),a.pos.y=d.pos.y,a.bounciness>0&&a.vel.y>a.minBounceVelocity?a.vel.y*=-a.bounciness:(a.standing=!0,a.vel.y=0)):(d=(a.vel.y-c.vel.y)/
2,a.vel.y=-d,c.vel.y=d,f=c.vel.x*b.system.tick,d=b.game.collisionMap.trace(a.pos.x,a.pos.y,f,-e/2,a.size.x,a.size.y),a.pos.y=d.pos.y,a=b.game.collisionMap.trace(c.pos.x,c.pos.y,0,e/2,c.size.x,c.size.y),c.pos.y=a.pos.y)}});b.module("g.game").requires("g.main").defines(function(){b.Game=b.Class.extend({clearColor:"#000000",gravity:0,screen:{x:0,y:0},entities:[],namedEntities:{},backgrounds:[],backgroundMaps:[],backgroundAnims:{},cellSize:64,run:function(){this.update();this.draw()},update:function(){for(var a=
0;a<this.entities.length;a++)this.entities[a].update();this.checkEntities();for(var b in this.backgroundAnims){var a=this.backgroundAnims[b],d;for(d in a)a[d].update()}for(a=0;a<this.backgroundMaps.length;a++)this.backgroundMaps[a].setScreenPos(this.screen.x,this.screen.y)},draw:function(){b.system.clear(this.clearColor);for(var a=0;a<this.backgrounds.length;a++)this.backgrounds[a].draw();for(a=0;a<this.backgroundMaps.length;a++)this.backgroundMaps[a].draw();for(a=0;a<this.entities.length;a++)this.entities[a].draw()},
spawnEntity:function(a,c,d,e){var f=typeof a==="string"?b.global[a]:a;if(!f)throw"Can't spawn entity of type "+a;a=new f(c,d,e||{});this.entities.push(a);e&&e.name&&(this.namedEntities[e.name]=a);return a},removeEntity:function(a){a.name&&delete this.namedEntities[a.name];this.entities.erase(a)},sortEntities:function(){this.entities.sort(function(a,b){return a.zIndex-b.zIndex})},getEntityByName:function(a){return this.namedEntities[a]},getEntitiesByType:function(a){for(var a=typeof a==="string"?b.global[a]:
a,c=[],d=0;d<this.entities.length;d++)this.entities[d]instanceof a&&c.push(this.entities[d]);return c},entitiesUnderMouse:function(){for(var a=ig.input.mouse.x,b=ig.input.mouse.y,d=this.entities,e=[],f=0;f<d.length;f+=1){var g=d[f],i=g.pos.x,h=g.pos.y;i<=a&&a<=i+g.size.x&&h<=b&&b<=h+g.size.y&&e.push(g)}return e},checkEntities:function(){for(var a={},c=0;c<this.entities.length;c++){var d=this.entities[c];if(!(c.type==b.Entity.TYPE.NONE&&c.checkAgainst==b.Entity.TYPE.NONE&&c.collides==b.Entity.COLLIDES.NEVER))for(var e=
{},f=(d.pos.x/this.cellSize).floor(),g=(d.pos.y/this.cellSize).floor(),i=((d.pos.x+d.size.x)/this.cellSize).floor()+1,h=((d.pos.y+d.size.y)/this.cellSize).floor()+1;f<i;f++)for(var k=g;k<h;k++)if(a[f])if(a[f][k]){for(var j=a[f][k],m=0;m<j.length;m++)d.touches(j[m])&&!e[j[m].id]&&(e[j[m].id]=!0,b.Entity.checkPair(d,j[m]));j.push(d)}else a[f][k]=[d];else a[f]={},a[f][k]=[d]}}})});b.module("g.debug.menu").requires("dom.ready","g.system").defines(function(){b.System.inject({run:function(){b.debug.beforeRun();
this.parent();b.debug.afterRun()},setGameNow:function(a){this.parent(a);b.debug.ready()}});b.Debug=b.Class.extend({options:{},panels:{},numbers:{},container:null,panelMenu:null,activePanel:null,debugTime:0,debugTickAvg:0.016,debugRealTime:Date.now(),init:function(){var a=b.$new("link");a.rel="stylesheet";a.type="text/css";a.href="assets/g.debug.css";b.$("body").appendChild(a);this.container=b.$new("div");this.container.className="g_debug";b.$("body").appendChild(this.container);this.panelMenu=b.$new("div");
this.panelMenu.innerHTML='<div class="g_debug_head">Debug:</div>';this.panelMenu.className="g_debug_panel_menu";this.container.appendChild(this.panelMenu);this.numberContainer=b.$new("div");this.numberContainer.className="g_debug_stats";this.panelMenu.appendChild(this.numberContainer);if(h.console&&h.console.log)b.log=h.console.log.bind(h.console);b.show=this.showNumber.bind(this)},addNumber:function(a){var c=b.$new("span");this.numberContainer.appendChild(c);this.numberContainer.appendChild(document.createTextNode(a));
this.numbers[a]=c},showNumber:function(a,b,d){this.numbers[a]||this.addNumber(a,d);this.numbers[a].textContent=b},addPanel:function(a){var c=new a.type(a.name,a.label);if(a.options)for(var d=0;d<a.options.length;d++){var e=a.options[d];c.addOption(new b.DebugOption(e.name,e.object,e.property))}this.panels[c.name]=c;c.container.style.display="none";this.container.appendChild(c.container);a=b.$new("div");a.className="g_debug_menu_item";a.textContent=c.label;a.addEventListener("click",function(a){this.togglePanel(a,
c)}.bind(this),!1);c.menuItem=a;e=!1;for(d=1;d<this.panelMenu.childNodes.length;d++){var f=this.panelMenu.childNodes[d];if(f.textContent>c.label){this.panelMenu.insertBefore(a,f);e=!0;break}}e||this.panelMenu.appendChild(a)},togglePanel:function(a,b){if(b!=this.activePanel&&this.activePanel)this.activePanel.toggle(!1),this.activePanel.menuItem.className="g_debug_menu_item",this.activePanel=null;var d=b.container.style.display!="block";b.toggle(d);a.target.className="g_debug_menu_item"+(d?" active":
"");if(d)this.activePanel=b},ready:function(){for(var a in this.panels)this.panels[a].ready()},beforeRun:function(){var a=Date.now();this.debugTickAvg=this.debugTickAvg*0.8+(a-this.debugRealTime)*0.2;this.debugRealTime=a;this.activePanel&&this.activePanel.beforeRun()},afterRun:function(){this.debugTime=this.debugTime*0.8+(Date.now()-this.debugRealTime)*0.2;this.activePanel&&this.activePanel.afterRun();this.showNumber("ms",this.debugTime.toFixed(2));this.showNumber("fps",Math.round(1E3/this.debugTickAvg));
this.showNumber("draws",b.Image.drawCount);b.game&&b.game.entities&&this.showNumber("entities",b.game.entities.length);b.Image.drawCount=0}});b.DebugPanel=b.Class.extend({active:!1,container:null,options:[],panels:[],label:"",name:"",init:function(a,c){this.name=a;this.label=c;this.container=b.$new("div");this.container.className="g_debug_panel "+this.name},toggle:function(a){this.active=a;this.container.style.display=a?"block":"none"},addPanel:function(a){this.panels.push(a);this.container.appendChild(a.container)},
addOption:function(a){this.options.push(a);this.container.appendChild(a.container)},ready:function(){},beforeRun:function(){},afterRun:function(){}});b.DebugOption=b.Class.extend({name:"",labelName:"",className:"g_debug_option",label:null,mark:null,container:null,active:!1,colors:{enabled:"#fff",disabled:"#444"},init:function(a,c,d){this.name=a;this.object=c;this.property=d;this.active=this.object[this.property];this.container=b.$new("div");this.container.className="g_debug_option";this.label=b.$new("span");
this.label.className="g_debug_label";this.label.textContent=this.name;this.mark=b.$new("span");this.mark.className="g_debug_label_mark";this.container.appendChild(this.mark);this.container.appendChild(this.label);this.container.addEventListener("click",this.click.bind(this),!1);this.setLabel()},setLabel:function(){this.mark.style.backgroundColor=this.active?this.colors.enabled:this.colors.disabled},click:function(a){this.active=!this.active;this.object[this.property]=this.active;this.setLabel();a.stopPropagation();
a.preventDefault();return!1}});b.debug=new b.Debug});b.module("g.debug.entities-panel").requires("g.debug.menu","g.entity").defines(function(){b.Entity.inject({colors:{names:"#fff",velocities:"#0f0",boxes:"#f00"},draw:function(){this.parent();if(b.Entity._debugShowBoxes)b.system.context.strokeStyle=this.colors.boxes,b.system.context.lineWidth=1,b.system.context.strokeRect(b.system.getDrawPos(this.pos.x.round()-b.game.screen.x)-0.5,b.system.getDrawPos(this.pos.y.round()-b.game.screen.y)-0.5,this.size.x*
b.system.scale,this.size.y*b.system.scale);if(b.Entity._debugShowVelocities){var a=this.pos.x+this.size.x/2,c=this.pos.y+this.size.y/2;this._debugDrawLine(this.colors.velocities,a,c,a+this.vel.x,c+this.vel.y)}if(b.Entity._debugShowNames){if(this.name)b.system.context.fillStyle=this.colors.names,b.system.context.fillText(this.name,b.system.getDrawPos(this.pos.x-b.game.screen.x),b.system.getDrawPos(this.pos.y-b.game.screen.y));if(typeof this.target=="object")for(var d in this.target)(a=b.game.getEntityByName(this.target[d]))&&
this._debugDrawLine(this.colors.names,this.pos.x+this.size.x/2,this.pos.y+this.size.y/2,a.pos.x+a.size.x/2,a.pos.y+a.size.y/2)}},_debugDrawLine:function(a,c,d,e,f){b.system.context.strokeStyle=a;b.system.context.lineWidth=1;b.system.context.beginPath();b.system.context.moveTo(b.system.getDrawPos(c-b.game.screen.x),b.system.getDrawPos(d-b.game.screen.y));b.system.context.lineTo(b.system.getDrawPos(e-b.game.screen.x),b.system.getDrawPos(f-b.game.screen.y));b.system.context.stroke();b.system.context.closePath()}});
b.Entity._debugEnableChecks=!0;b.Entity._debugShowBoxes=!1;b.Entity._debugShowVelocities=!1;b.Entity._debugShowNames=!1;b.Entity.oldCheckPair=b.Entity.checkPair;b.Entity.checkPair=function(a,c){b.Entity._debugEnableChecks&&b.Entity.oldCheckPair(a,c)};b.debug.addPanel({type:b.DebugPanel,name:"entities",label:"Entities",options:[{name:"Checks & Collisions",object:b.Entity,property:"_debugEnableChecks"},{name:"Show Collision Boxes",object:b.Entity,property:"_debugShowBoxes"},{name:"Show Velocities",
object:b.Entity,property:"_debugShowVelocities"},{name:"Show Names & Targets",object:b.Entity,property:"_debugShowNames"}]})});b.module("g.debug.maps-panel").requires("g.debug.menu","g.game","g.background-map").defines(function(){b.Game.inject({loadLevel:function(a){this.parent(a);b.debug.panels.maps.load(this)}});b.DebugMapsPanel=b.DebugPanel.extend({maps:[],mapScreens:[],init:function(a,b){this.parent(a,b);this.load()},load:function(a){this.options=[];this.panels=[];if(!a||!a.backgroundMaps.length)this.container.innerHTML=
"<em>No Maps Loaded</em>";else{this.maps=a.backgroundMaps;this.mapScreens=[];this.container.innerHTML="";for(a=0;a<this.maps.length;a++){var c=this.maps[a],d=new b.DebugPanel(a,"Layer "+a),e=new b.$new("strong");e.textContent=a+": "+c.tiles.path;d.container.appendChild(e);d.addOption(new b.DebugOption("Enabled",c,"enabled"));d.addOption(new b.DebugOption("Pre Rendered",c,"preRender"));d.addOption(new b.DebugOption("Show Chunks",c,"debugChunks"));this.generateMiniMap(d,c,a);this.addPanel(d)}}},generateMiniMap:function(a,
c,d){var e=b.system.scale,f=b.$new("canvas"),g=f.getContext("2d"),i=c.tiles.width*e,h=c.tiles.height*e,k=i/c.tilesize;g.drawImage(c.tiles.data,0,0,i,h,0,0,k,h/c.tilesize);g=b.$new("canvas");g.width=c.width*e;g.height=c.height*e;var j=g.getContext("2d");if(b.game.clearColor)j.fillStyle=b.game.clearColor,j.fillRect(0,0,i,h);for(h=i=0;h<c.width;h++)for(var m=0;m<c.height;m++)(i=c.data[m][h])&&j.drawImage(f,Math.floor((i-1)*e%k),Math.floor((i-1)*e/k)*e,e,e,h*e,m*e,e,e);f=b.$new("div");f.className="g_debug_map_container";
f.style.width=c.width*e+"px";f.style.height=c.height*e+"px";k=b.$new("div");k.className="g_debug_map_screen";k.style.width=b.system.width/c.tilesize*e-2+"px";k.style.height=b.system.height/c.tilesize*e-2+"px";this.mapScreens[d]=k;f.appendChild(g);f.appendChild(k);a.container.appendChild(f)},afterRun:function(){for(var a=b.system.scale,c=0;c<this.maps.length;c++){var d=this.maps[c],e=this.mapScreens[c];if(d&&e){var f=d.scroll.x/d.tilesize,g=d.scroll.y/d.tilesize;d.repeat&&(f%=d.width,g%=d.height);
e.style.left=f*a+"px";e.style.top=g*a+"px"}}}});b.debug.addPanel({type:b.DebugMapsPanel,name:"maps",label:"Background Maps"})});b.module("g.debug.graph-panel").requires("g.debug.menu","g.system","g.game","g.image").defines(function(){b.Game.inject({draw:function(){b.graph.beginClock("draw");this.parent();b.graph.endClock("draw")},update:function(){b.graph.beginClock("update");this.parent();b.graph.endClock("update")},checkEntities:function(){b.graph.beginClock("checks");this.parent();b.graph.endClock("checks")}});
b.DebugGraphPanel=b.DebugPanel.extend({clocks:{},marks:[],textY:0,height:128,ms:64,timeBeforeRun:0,init:function(a,c){this.parent(a,c);this.mark16ms=(this.height-this.height/this.ms*16).round();this.mark33ms=(this.height-this.height/this.ms*33).round();this.msHeight=this.height/this.ms;this.graph=b.$new("canvas");this.graph.width=h.innerWidth;this.graph.height=this.height;this.container.appendChild(this.graph);this.ctx=this.graph.getContext("2d");this.ctx.fillStyle="#444";this.ctx.fillRect(0,this.mark16ms,
this.graph.width,1);this.ctx.fillRect(0,this.mark33ms,this.graph.width,1);this.addGraphMark("16ms",this.mark16ms);this.addGraphMark("33ms",this.mark33ms);this.addClock("draw","Draw","#13baff");this.addClock("update","Entity Update","#bb0fff");this.addClock("checks","Entity Checks & Collisions","#a2e908");this.addClock("lag","System Lag","#f26900");b.mark=this.mark.bind(this);b.graph=this},addGraphMark:function(a,c){var d=b.$new("span");d.className="g_debug_graph_mark";d.textContent=a;d.style.top=
c.round()+"px";this.container.appendChild(d)},addClock:function(a,c,d){var e=b.$new("span");e.className="g_debug_legend_color";e.style.backgroundColor=d;var f=b.$new("span");f.className="g_debug_legend_number";f.appendChild(document.createTextNode("0"));var g=b.$new("span");g.className="g_debug_legend";g.appendChild(e);g.appendChild(document.createTextNode(c+" ("));g.appendChild(f);g.appendChild(document.createTextNode("ms)"));this.container.appendChild(g);this.clocks[a]={description:c,color:d,current:0,
start:Date.now(),avg:0,html:f}},beginClock:function(a,b){this.clocks[a].start=Date.now()+(b||0)},endClock:function(a){a=this.clocks[a];a.current=Math.round(Date.now()-a.start);a.avg=a.avg*0.8+a.current*0.2},mark:function(a,b){this.active&&this.marks.push({msg:a,color:b||"#fff"})},beforeRun:function(){this.endClock("lag");this.timeBeforeRun=Date.now()},afterRun:function(){var a=Date.now()-this.timeBeforeRun;this.beginClock("lag",Math.max(1E3/b.system.fps-a,0));var a=this.graph.width-1,c=this.height;
this.ctx.drawImage(this.graph,-1,0);this.ctx.fillStyle="#000";this.ctx.fillRect(a,0,1,this.height);this.ctx.fillStyle="#444";this.ctx.fillRect(a,this.mark16ms,1,1);this.ctx.fillStyle="#444";this.ctx.fillRect(a,this.mark33ms,1,1);for(var d in this.clocks){var e=this.clocks[d];e.html.textContent=e.avg.toFixed(2);if(e.color&&e.current>0){this.ctx.fillStyle=e.color;var f=e.current*this.msHeight;c-=f;this.ctx.fillRect(a,c,1,f);e.current=0}}this.ctx.textAlign="right";this.ctx.textBaseline="top";this.ctx.globalAlpha=
0.5;for(d=0;d<this.marks.length;d++)if(c=this.marks[d],this.ctx.fillStyle=c.color,this.ctx.fillRect(a,0,1,this.height),c.msg)this.ctx.fillText(c.msg,a-1,this.textY),this.textY=(this.textY+8)%32;this.ctx.globalAlpha=1;this.marks=[]}});b.debug.addPanel({type:b.DebugGraphPanel,name:"graph",label:"Performance"})});b.module("g.animation-debug-panel").requires("g.debug.menu","g.entity","g.game").defines(function(){b.Game.inject({loadLevel:function(a){this.parent(a);b.debug.panels.animationpanel.load(this)}});
b.Entity.inject({_shouldUpdate:!0,update:function(){this._shouldUpdate&&this.parent()}});AnimationDebugPanel=b.DebugPanel.extend({init:function(a,b){this.parent(a,b);this.container.innerHTML="<em>Entities not loaded yet.</em>"},load:function(a){this.container.innerHTML="";for(var b=0;b<a.entities.length;b++){var d=a.entities[b];d.name&&this.addOption(new ig.DebugOption("Entity "+d.name,d,"_shouldUpdate"))}},ready:function(){},beforeRun:function(){},afterRun:function(){}});b.debug.addPanel({type:AnimationDebugPanel,
name:"Animationpanel",label:"Animation"})});b.module("g.debug").requires("g.debug.entities-panel","g.debug.maps-panel","g.debug.graph-panel").defines(function(){});if(typeof h!=="undefined")h._g=b})(window);Number.prototype.map=function(h,b,n,o){return n+(o-n)*((this-h)/(b-h))};Number.prototype.limit=function(h,b){return Math.min(b,Math.max(h,this))};Number.prototype.round=function(h){h=Math.pow(10,h||0);return Math.round(this*h)/h};Number.prototype.floor=function(){return Math.floor(this)};
Number.prototype.ceil=function(){return Math.ceil(this)};Number.prototype.toInt=function(){return this|0};Array.prototype.erase=function(h){for(var b=this.length;b--;)this[b]===h&&this.splice(b,1);return this};Array.prototype.random=function(){return this[(Math.random()*this.length).floor()]};Function.prototype.bind=function(h){var b=this;return function(){var n=Array.prototype.slice.call(arguments);return b.apply(h||null,n)}};
